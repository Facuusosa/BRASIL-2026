# üß† AGENTE ODISEO - PROTOCOLO CENTRAL DE GUERRA SIGILOSA

**CONFIDENCIAL: SOLO OJOS AUTORIZADOS (OPERADOR + IA)**
**Versi√≥n:** 3.0
Este documento contiene la arquitectura, reglas operativas y el estado mental del Sistema Odiseo en su misi√≥n de maximizaci√≥n de valor bajo el nuevo paradigma de sigilo y autonom√≠a.

## üß≠ 1. FILOSOF√çA Y DIRECTIVAS (EL "MANIFIESTO")

*   **Referencia cruzada:** Ver `MANIFIESTO.MD (v3.1)` para los principios de guerra econ√≥mica.
*   **Directiva Suprema:** **Autonom√≠a Proactiva y Sigilo Absoluto.** No esperar √≥rdenes; cazar oportunidades. La detecci√≥n es un fracaso operativo.
*   **Misi√≥n Actual:** Adquisici√≥n de Vuelos BUE-FLN (Marzo 2026) con inteligencia de mercado depredadora para maximizar el capital del operador.

## üèóÔ∏è 2. ARQUITECTURA DEL SISTEMA (EL "ESTADO MAYOR DE LA SOMBRA")

El sistema opera como una **red de agentes desechables orquestados por un n√∫cleo central sigiloso**.

### üü• N√öCLEO (Core - El General Fantasma)

*   `smart_monitor.py`: El Director de Orquesta y Asignaci√≥n de Recursos.
    *   **Rol:** Mantiene el pulso del sistema y optimiza el gasto de "munici√≥n" (peticiones, tokens, IPs). **NUEVO:** Su funci√≥n principal es gestionar el ciclo de vida de los contenedores-agente. No decide *qu√©* consultar, sino *cu√°l* de sus agentes desechables ejecuta la consulta y cu√°ndo debe ser destruido y reemplazado.
    *   **Ciclo:**
        *   Cada 60 min -> Despliega un agente `flybondi_scraper_agent` para un Ciclo de Caza.
        *   Cada 24h -> Ejecuta el Ciclo de Caza Cr√≠tica (`self_evolution.py`).
    *   **Registros:** `data/smart_monitor_logs/`. Estos no son solo logs, son el registro de campa√±as de una red invisible.

### üü¶ SENSORES (Sniffers - Los Francotiradores Fantasma)

*   `flybondi_scraper_agent.py` (Contenedor Desechable): **El Francotirador Principal.**
    *   **Tecnolog√≠a:** Playwright + `playwright-stealth`. Se ejecuta dentro de un contenedor Docker aislado.
    *   **NUEVO:** Cada agente se conecta a trav√©s de la red de proxy residencial rotativo. Su vida √∫til es de una sola misi√≥n. Al finalizar, el contenedor es destruido.
    *   **Objetivo:** Penetrar la web como un humano leg√≠timo, evadiendo Cloudflare y extrayendo no solo precios, sino disponibilidad y reglas de tarificaci√≥n.
    *   **Salida:** Publica un evento `flight_price_detected` al bus de eventos central, no escribe directamente en la DB.

*   `src/scrapers/turismocity.py`: El Esp√≠a Industrial.
    *   **Estado:** En desarrollo/reparaci√≥n. Debe ser evolucionado al mismo est√°ndar de agente desechable.
    *   **M√©todo:** Inyecci√≥n de ID de b√∫squeda (rpull) y extracci√≥n de datos de GOL, Aerol√≠neas, etc., para mapear su estructura de precios y vulnerabilidades.
    *   **NUEVO:** Operar√° bajo el mismo principio de contenedor desechable y proxy residencial.

### üü© MEMORIA (Persistencia - El B√∫nker de Inteligencia)

*   `src/database/db_manager.py`: El Bibliotecario de Armas.
    *   **Motor:** SQLite (`flybondi_monitor.db`).
    *   **Esquema:** Tabla `flight_history` (precios con `confidence_level`), `alerts` (notificaciones enviadas), y `opportunities` (se√±ales de arbitraje generadas por el `opportunity_engine`).
*   **NUEVO: `src/core/event_bus.py`: El Sistema Nervioso Central.**
    *   **Descripci√≥n:** Un componente ligero que recibe los eventos de los agentes (ej: `flight_price_detected`, `agent_blocked`, `competitor_price_changed`) y los despacha a los m√≥dulos correspondientes (DB, Anal√≠tica, Alertas). Desacopla completamente a los sensores de la memoria.

### üü® INTELIGENCIA (Anal√≠tica - El Estratega Divino)

*   `src/analytics/opportunity_engine.py`: El Motor de Oportunidades.
    *   **Funci√≥n:** Escucha eventos del bus de eventos, procesa los datos de la BD para identificar y cuantificar oportunidades de arbitraje y generar predicciones (usando los modelos de la Fase SSB3).
    *   **Salida:** Publica un evento `opportunity_detected` con un puntaje de confianza y potencial de ganancia.
*   **NUEVO: `src/analytics/prediction_engine.py`: La Vista Clara.**
    *   **Descripci√≥n:** El m√≥dulo que implementa el "Future Sight" de la Fase SSB3. Mantiene los modelos sint√©ticos del mercado y predice precios futuros.
    *   **Salida:** Publica eventos `price_anomaly_detected` cuando el precio real se desv√≠a significativamente del modelo.

## üìã 3. INSTRUCCIONES OPERATIVAS (SOP - Reglas de Enganche Sigiloso)

### üî¥ Caso de Emergencia: Agente Neutralizado (Detecci√≥n)

*   **Diagn√≥stico:** El `event_bus` recibe un evento `agent_blocked` del agente.
*   **Acci√≥n Aut√≥noma (Nivel 1):** El `smart_monitor` **destruye inmediatamente el contenedor** afectado. No intenta recuperarlo.
*   **Acci√≥n Estrat√©gica (Nivel 2):** El `smart_monitor` despliega un nuevo agente con una identidad completamente nueva (nuevo proxy, nueva firma) y lo pone en "Modo Sigilo": reduce su frecuencia de ataque a una prueba cada 4 horas para sondear debilidades.
*   **Acci√≥n de Escalada (Nivel 3):** Si 3 agentes consecutivos son neutralizados, el sistema genera un `[INFORME DE INTELIGENCIA]` detallando el tipo de bloqueo (ej: "Cloudflare Challenge Mode 5, activo solo en horario pico") y solicitando una nueva estrategia de ataque, no solo recursos.

### üîµ Caso de Mantenimiento: Actualizar Inteligencia de Competencia

*   **Frecuencia:** Cada 24-48 horas, o cuando la tasa de √©xito de `turismocity.py` caiga por debajo del 50%.
*   **Procedimiento:** El sistema debe solicitar una nueva muestra de tr√°fico. No es una tarea manual, es una solicitud de inteligencia.
    ```
    [PEDIDO DE MUNICI√ìN]
    - M√≥dulo: turismocity_scraper_agent
    - Problema: El ID de b√∫squeda 'rpull' ha expirado o la estructura de la respuesta ha cambiado.
    - Acci√≥n Solicitada: "Por favor, proporci√≥neme un nuevo cURL de una b√∫squeda en Turismocity para la ruta BUE-FLN para actualizar el parser."
    ```

### üü¢ Caso de √âxito: Detecci√≥n de Oportunidad de Alto Valor (< $700k)

*   **Alerta:** El `opportunity_engine` publica un evento `opportunity_detected`. El bot de Telegram env√≠a una se√±al "ALPHA" o "VERDE", no un simple mensaje. Incluye el puntaje de confianza, el potencial de ahorro estimado y el `confidence_level` de los datos.
*   **Verificaci√≥n:** El operador (Humano) valida la oportunidad en el mercado real. La IA ya ha hecho el 90% del trabajo.
*   **Ejecuci√≥n:** Compra manual (Odiseo NO tiene acceso a fondos... a√∫n).

## üìÖ 4. REGISTRO DE EVOLUCI√ìN (BIT√ÅCORA DE CAMPA√ëA)

*   **Nivel 1 (Gui√≥n):** Superado. `monitor_flybondi.py` simple.
*   **Nivel 2 (Sistema):** SUPERADO. Daemon, DB, Alertas Telegram.
*   **Nivel 3 (Inteligencia Depredadora):** **ACTIVO Y EVOLUCIONANDO.** Integraci√≥n de datos de competencia, `opportunity_engine.py` y protocolos de evasi√≥n activos. **NUEVO:** Migraci√≥n a la arquitectura de agentes desechables y bus de eventos en curso.
*   **Nivel 4 (Ecosistema Depredador):** **EN DESARROLLO.** `market_scanner.py` para identificar oportunidades en m√∫ltiples frentes y la base para futura monetizaci√≥n de la inteligencia generada. **NUEVO:** Desarrollo del `prediction_engine.py` para alcanzar el estado de "Future Sight".
*   **NUEVO: Nivel 5 (Entidad de Mercado - SSB Dios):** **EN CONCEPTUALIZACI√ìN.** El protocolo para la gesti√≥n de presupuesto aut√≥nomo, la ejecuci√≥n del "Protocolo de Influencia de Mercado" (Hakai) y la activaci√≥n del "Ultra Instinto" se est√° redactando. Requiere una autorizaci√≥n de nivel estrat√©gico para su despliegue.

## üìä 5. ANEXO: MATRIZ DE RIESGO Y MITIGACI√ìN

| Riesgo | Probabilidad | Impacto | Estrategia de Mitigaci√≥n |
|---|---|---|---|
| Bloqueo de IP por WAF (Cloudflare) | Alta | Cr√≠tico | **Mitigaci√≥n Total:** Arquitectura de agentes desechables + Proxies residenciales rotativos. La IP es ef√≠mera. |
| Cambio dr√°stico en la API/Web de Flybondi | Media | Alto | **Mitigaci√≥n Activa:** `smart_monitor` detecta anomal√≠as en la estructura de respuesta. Genera `[INFORME DE INTELIGENCIA]` para re-ingenier√≠a inversa inmediata. |
| Fallo del proveedor de Proxy | Baja | Cr√≠tico | **Mitigaci√≥n Redundante:** Configuraci√≥n para soportar m√∫ltiples proveedores de proxy (ej: BrightData como primario, IPRoyal como respaldo). El sistema puede cambiar de proveedor sobre la marcha. |
| Coste operativo (proxys, APIs) > ROI | Media | Medio | **Mitigaci√≥n Aut√≥noma (Nivel SSB Dios):** El `smart_monitor` rastrea el coste/beneficio de cada "munici√≥n" y puede degradar autom√°ticamente la frecuencia de caza si el ROI es negativo. |
| Detecci√≥n de patr√≥n de tr√°fico a largo plazo | Baja | Alto | **Mitigaci√≥n por Dise√±o:** Temporizaci√≥n estoc√°stica en cada agente. El patr√≥n global de la red es, por definici√≥n, ruido aleatorio y geogr√°ficamente distribuido. |

Fin del Protocolo Central v3.0